<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discipline Architect</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117;
            color: #c9d1d9;
            background-image: 
                linear-gradient(rgba(0, 255, 70, 0.07) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 70, 0.07) 1px, transparent 1px);
            background-size: 20px 20px;
        }
        .timer-display, .font-mono {
            font-family: 'Roboto Mono', monospace;
        }
        .nav-button {
            transition: all 0.2s ease-in-out;
            color: #8b949e;
        }
        .nav-button:hover {
            color: #c9d1d9;
        }
        .nav-button.active, .filter-btn.active, .manual-mode-btn.active {
            background-color: #2ea043;
            color: #ffffff;
            box-shadow: 0 0 15px rgba(46, 160, 67, 0.5);
        }
        .card {
            background-color: #161b22;
            border-radius: 1rem;
            border: 1px solid #30363d;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out, border-color 0.3s ease-in-out;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
            border-color: #2ea043;
        }
        .page {
            display: none;
            animation: fadeIn 0.5s;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .page.active { display: block; }

        .session-log-item:hover .delete-session-btn { opacity: 1; transform: scale(1); }
        .delete-session-btn { opacity: 0; transform: scale(0.8); transition: all 0.2s ease-in-out; }
        
        input, select {
            background-color: #0d1117;
            border-color: #30363d;
            color: #c9d1d9;
        }
        input::placeholder {
            color: #8b949e;
            opacity: 1;
        }
        input:focus, select:focus {
            --tw-ring-color: #2ea043;
        }
        select option {
            background-color: #161b22;
        }
        select {
            color-scheme: dark;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0d1117; }
        ::-webkit-scrollbar-thumb { background: #30363d; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #2ea043; }
        
        #toast {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            padding: 12px 24px; border-radius: 8px; color: white;
            opacity: 0; visibility: hidden; transition: all 0.3s ease; z-index: 100;
            background-color: #161b22; border: 1px solid #30363d;
        }
        #toast.show { opacity: 1; visibility: visible; transform: translate(-50%, -10px); }
        
        #confirmation-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex; align-items: center; justify-content: center;
            z-index: 200; opacity: 0; visibility: hidden; transition: all 0.3s ease;
        }
        #confirmation-modal.show { opacity: 1; visibility: visible; }
        #confirmation-modal .modal-content {
             background: #161b22; padding: 2rem; border-radius: 1rem; border: 1px solid #30363d;
             transform: scale(0.95); transition: all 0.3s ease;
             width: 90%; max-width: 400px;
        }
        #confirmation-modal.show .modal-content { transform: scale(1); }

        #password-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #0d1117;
            display: flex; align-items: center; justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .shake {
            animation: shake 0.3s ease-in-out;
        }
    </style>
</head>
<body class="min-h-screen">

    <div id="password-overlay">
        <div class="card p-8 w-full max-w-sm text-center">
            <h2 class="text-2xl font-bold mb-4 text-white">Enter Access Code</h2>
            <p class="text-gray-400 mb-6">Enter the password to access the application.</p>
            <input type="password" id="password-input" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 text-center" placeholder="••••••••">
            <button id="password-submit" class="w-full mt-4 bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700">Unlock</button>
        </div>
    </div>

    <div id="app-container" class="hidden">
        <div id="toast" class="bg-gray-800"></div>
        
        <div id="confirmation-modal">
            <div class="modal-content text-center">
                <h3 class="text-xl font-bold mb-4 text-white">Are you sure?</h3>
                <p class="text-gray-400 mb-6">This action cannot be undone.</p>
                <div class="flex justify-center gap-4">
                    <button id="modal-cancel-btn" class="w-full bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700">Cancel</button>
                    <button id="modal-confirm-btn" class="w-full bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700">Delete</button>
                </div>
            </div>
        </div>

        <div class="container mx-auto p-4 max-w-5xl">
            <header class="text-center mb-6">
                <h1 class="text-4xl md:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-green-400 to-green-600 tracking-tight">
                    Discipline Architect
                </h1>
                <p class="text-gray-400 mt-2">Build your focus. Master your time.</p>
                <div id="live-clock" class="font-mono text-lg text-green-400 mt-4"></div>
            </header>

            <nav class="flex justify-center bg-[#161b22] border border-[#30363d] rounded-xl shadow-lg p-2 mb-8 sticky top-4 z-10">
                <button id="nav-dashboard" class="nav-button active font-semibold py-2 px-6 rounded-lg">Dashboard</button>
                <button id="nav-analysis" class="nav-button font-semibold py-2 px-6 rounded-lg">Analysis</button>
                <button id="nav-data" class="nav-button font-semibold py-2 px-6 rounded-lg">Data</button>
            </nav>

            <main>
                <div id="page-dashboard" class="page active">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="flex flex-col gap-8">
                            <div id="current-session-card" class="card p-6 hidden">
                                <h2 class="text-2xl font-bold mb-2 text-green-400">Active Session</h2>
                                <p id="current-session-title" class="text-xl font-semibold text-gray-200"></p>
                                <p id="current-session-category" class="text-sm text-gray-400 mb-4"></p>
                                <div id="timer" class="timer-display text-6xl font-bold text-center my-4 text-gray-200">00:00:00</div>
                                <button id="end-session-btn" class="w-full bg-red-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-700 transition-colors shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">End Session</button>
                            </div>
                            
                            <div id="start-session-card" class="card p-6">
                                <h2 class="text-2xl font-bold mb-4 text-white">Start a New Session</h2>
                                <div class="space-y-4">
                                    <input type="text" id="session-title" placeholder="What are you working on?" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2">
                                    <select id="session-category" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2">
                                        <option>Study</option><option>Work</option><option>Fitness</option><option>Reading</option><option>Entertainment</option><option>YouTube</option><option>Instagram</option><option>Chores</option><option>Social</option><option>Other</option>
                                    </select>
                                    <button id="start-session-btn" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition-colors shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">Start Session</button>
                                </div>
                            </div>

                            <div id="manual-session-card" class="card p-6">
                                <h2 class="text-2xl font-bold mb-4 text-white">Add a Manual Session (Today)</h2>
                                <div class="space-y-4">
                                    <input type="text" id="manual-session-title" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2" placeholder="Session Title">
                                    <select id="manual-session-category" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2">
                                        <option>Study</option><option>Work</option><option>Fitness</option><option>Reading</option><option>Entertainment</option><option>YouTube</option><option>Instagram</option><option>Chores</option><option>Social</option><option>Other</option>
                                    </select>
                                
                                    <div class="flex bg-[#0d1117] rounded-lg p-1 border border-[#30363d]">
                                        <button id="manual-mode-precise" class="manual-mode-btn w-1/2 p-2 rounded-md text-sm font-semibold">Precise Time</button>
                                        <button id="manual-mode-duration" class="manual-mode-btn w-1/2 p-2 rounded-md text-sm font-semibold">Duration</button>
                                    </div>
                            
                                    <div id="manual-precise-inputs" class="hidden space-y-4">
                                        <div class="flex gap-4">
                                            <div class="w-1/2">
                                                <label class="text-xs text-gray-400">Start Time</label>
                                                <input type="time" id="manual-start-time" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2">
                                            </div>
                                            <div class="w-1/2">
                                                <label class="text-xs text-gray-400">End Time</label>
                                                <input type="time" id="manual-end-time" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2">
                                            </div>
                                        </div>
                                    </div>
                            
                                    <div id="manual-duration-inputs" class="hidden space-y-4">
                                        <div class="flex gap-4">
                                            <div class="w-1/2">
                                                <label class="text-xs text-gray-400">Hours</label>
                                                <input type="number" id="manual-duration-hours" min="0" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2" placeholder="Hours">
                                            </div>
                                            <div class="w-1/2">
                                                <label class="text-xs text-gray-400">Minutes</label>
                                                <input type="number" id="manual-duration-minutes" min="0" max="59" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2" placeholder="Mins">
                                            </div>
                                        </div>
                                    </div>
                            
                                    <button id="add-manual-session-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors shadow-lg">Add Manual Session</button>
                                </div>
                            </div>
                        </div>

                        <div class="card p-6 flex flex-col">
                            <h2 class="text-2xl font-bold mb-4 text-white">Today's Log</h2>
                            <div id="todays-log" class="space-y-3 flex-grow overflow-y-auto pr-2 h-96">
                            <p id="no-sessions-msg" class="text-gray-500 text-center mt-10">No sessions logged yet today. Start one to begin!</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="page-analysis" class="page pb-8">
                    <div class="card p-6 mb-8">
                        <h2 class="text-2xl font-bold mb-4 text-white">Analyze Your Time</h2>
                        <p class="text-gray-400 mb-4">Use the filters below to see how you've spent your time. Your data is based on imported files and sessions saved in this browser.</p>
                        <div class="flex flex-wrap items-center gap-4">
                            <div class="flex gap-2">
                                <button data-period="today" class="filter-btn font-semibold py-2 px-4 rounded-lg bg-[#30363d] hover:bg-[#48515c]">Today</button>
                                <button data-period="week" class="filter-btn font-semibold py-2 px-4 rounded-lg bg-[#30363d] hover:bg-[#48515c]">This Week</button>
                                <button data-period="month" class="filter-btn font-semibold py-2 px-4 rounded-lg bg-[#30363d] hover:bg-[#48515c]">This Month</button>
                            </div>
                            <div class="flex-grow">
                                <input type="date" id="date-filter" class="w-full p-2 border rounded-md shadow-sm focus:outline-none focus:ring-2" placeholder="Select a date">
                            </div>
                            <button id="reset-filter-btn" class="bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700">All Time</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="card p-6">
                            <h2 id="stats-title" class="text-xl font-bold mb-4 text-white">Key Statistics</h2>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <p class="text-gray-400 text-sm">Total Time Tracked</p>
                                    <p id="stats-total-time" class="text-2xl font-bold text-green-400 font-mono"></p>
                                </div>
                                <div>
                                    <p class="text-gray-400 text-sm">Productivity Score</p>
                                    <p id="stats-productivity-score" class="text-2xl font-bold text-green-400 font-mono"></p>
                                </div>
                                <div>
                                    <p class="text-gray-400 text-sm">Avg. Session</p>
                                    <p id="stats-avg-session" class="text-2xl font-bold text-green-400 font-mono"></p>
                                </div>
                                 <div>
                                    <p class="text-gray-400 text-sm">Most Frequent</p>
                                    <p id="stats-most-frequent" class="text-2xl font-bold text-green-400 font-mono"></p>
                                </div>
                                <div class="col-span-2">
                                    <p class="text-gray-400 text-sm">Most Productive Day</p>
                                    <p id="stats-most-productive-day" class="text-2xl font-bold text-green-400 font-mono"></p>
                                </div>
                            </div>
                        </div>
                        <div class="card p-6">
                             <h2 id="pie-chart-title" class="text-xl font-bold mb-4 text-white">Category Breakdown</h2>
                             <div class="h-64"><canvas id="category-pie-chart"></canvas></div>
                        </div>
                        <div class="card p-6">
                            <h2 id="bar-chart-title" class="text-xl font-bold mb-4 text-white">Activity by Category</h2>
                            <div class="h-64"><canvas id="activity-bar-chart"></canvas></div>
                        </div>
                        <div class="card p-6">
                            <h2 class="text-xl font-bold mb-4 text-white">Productive vs. Distraction</h2>
                            <div class="h-64"><canvas id="productivity-split-chart"></canvas></div>
                        </div>
                    </div>
                    <div class="card p-6 mt-8">
                        <h2 class="text-xl font-bold mb-4 text-white">Recent Productivity Trend (Last 7 Days)</h2>
                        <div class="h-80"><canvas id="productivity-line-chart"></canvas></div>
                    </div>
                    <div class="card p-6 mt-8">
                        <h2 id="session-details-title" class="text-xl font-bold mb-4 text-white">Session Details</h2>
                        <div id="session-details-list" class="space-y-2 max-h-96 overflow-y-auto pr-2">
                            <!-- Session details will be rendered here -->
                        </div>
                    </div>
                </div>

                <div id="page-data" class="page">
                    <div class="card p-8 max-w-lg mx-auto">
                        <h2 class="text-2xl font-bold mb-4 text-white">Cloud Data (GitHub)</h2>
                        <p class="text-gray-400 mb-4">Load all your historical data from your GitHub repository. Requires a `data_manifest.json` file. This will replace any data currently in the browser.</p>
                        <button id="load-github-btn" class="w-full bg-purple-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-purple-700">Load from Cloud</button>
                    </div>

                    <div class="card p-8 max-w-lg mx-auto mt-8">
                        <h2 class="text-2xl font-bold mb-4 text-white">Local Browser Data</h2>
                        <p class="text-gray-400 mb-6">Manage the data stored directly in your browser. Use this to save backups or import local files.</p>
                        <div class="space-y-4">
                            <button id="export-today-btn" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700">Save Today's Data</button>
                            <button id="export-data-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700">Export All Data</button>
                            <div>
                                <input type="file" id="import-file-input" class="hidden" accept=".json" multiple>
                                <button id="import-data-btn" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700">Import Local File(s)</button>
                            </div>
                            <hr class="border-gray-600 my-4">
                            <button id="clear-data-btn" class="w-full bg-red-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-700">Clear All Browser Data</button>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {

        const _appConfigKey = 'eWV5ZXll'; // Obfuscated password "yeyeye"
        const appContainer = document.getElementById('app-container');
        const passwordOverlay = document.getElementById('password-overlay');
        const passwordInput = document.getElementById('password-input');
        const passwordSubmit = document.getElementById('password-submit');
        const passwordCard = passwordOverlay.querySelector('.card');

        const checkPassword = () => {
            if (passwordInput.value === atob(_appConfigKey)) {
                passwordOverlay.style.opacity = '0';
                setTimeout(() => {
                    passwordOverlay.style.display = 'none';
                    appContainer.classList.remove('hidden');
                    initializeApp();
                }, 500);
            } else {
                passwordCard.classList.add('shake');
                passwordInput.value = '';
                passwordInput.focus();
                setTimeout(() => passwordCard.classList.remove('shake'), 300);
            }
        };

        passwordSubmit.addEventListener('click', checkPassword);
        passwordInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                checkPassword();
            }
        });
        
        function initializeApp() {
            Chart.defaults.color = '#c9d1d9';
            Chart.defaults.borderColor = '#30363d';
            
            let state = {
                sessions: JSON.parse(localStorage.getItem('disciplineArchitectSessions')) || {},
                currentSession: null, activePage: 'dashboard',
                categoryChart: null, activityChart: null, lineChart: null, splitChart: null,
                sessionToDelete: null,
            };

            const pages = { dashboard: document.getElementById('page-dashboard'), analysis: document.getElementById('page-analysis'), data: document.getElementById('page-data') };
            const nav = { dashboard: document.getElementById('nav-dashboard'), analysis: document.getElementById('nav-analysis'), data: document.getElementById('nav-data') };
            const sessionControls = {
                titleInput: document.getElementById('session-title'), categorySelect: document.getElementById('session-category'),
                startButton: document.getElementById('start-session-btn'), endButton: document.getElementById('end-session-btn'),
                startCard: document.getElementById('start-session-card'), currentCard: document.getElementById('current-session-card'),
                currentTitle: document.getElementById('current-session-title'), currentCategory: document.getElementById('current-session-category'),
                timer: document.getElementById('timer'),
            };
            const logs = { today: document.getElementById('todays-log') };
            const analysisElements = {
                dateFilter: document.getElementById('date-filter'), resetFilterBtn: document.getElementById('reset-filter-btn'),
                statsTitle: document.getElementById('stats-title'), pieChartTitle: document.getElementById('pie-chart-title'), barChartTitle: document.getElementById('bar-chart-title'),
                categoryCanvas: document.getElementById('category-pie-chart'), activityCanvas: document.getElementById('activity-bar-chart'),
                lineCanvas: document.getElementById('productivity-line-chart'),
                splitCanvas: document.getElementById('productivity-split-chart'),
                sessionDetailsList: document.getElementById('session-details-list'),
                sessionDetailsTitle: document.getElementById('session-details-title'),
                statsTotalTime: document.getElementById('stats-total-time'), 
                statsProductivityScore: document.getElementById('stats-productivity-score'),
                statsAvgSession: document.getElementById('stats-avg-session'),
                statsMostFrequent: document.getElementById('stats-most-frequent'),
                statsMostProductiveDay: document.getElementById('stats-most-productive-day'),
                filterBtns: document.querySelectorAll('.filter-btn'),
            };
            const dataControls = {
                loadGithubBtn: document.getElementById('load-github-btn'),
                exportTodayButton: document.getElementById('export-today-btn'),
                exportButton: document.getElementById('export-data-btn'),
                importButton: document.getElementById('import-data-btn'),
                importInput: document.getElementById('import-file-input'),
                clearButton: document.getElementById('clear-data-btn'),
            };
            const manualControls = {
                title: document.getElementById('manual-session-title'),
                category: document.getElementById('manual-session-category'),
                modePreciseBtn: document.getElementById('manual-mode-precise'),
                modeDurationBtn: document.getElementById('manual-mode-duration'),
                preciseInputs: document.getElementById('manual-precise-inputs'),
                durationInputs: document.getElementById('manual-duration-inputs'),
                startTime: document.getElementById('manual-start-time'),
                endTime: document.getElementById('manual-end-time'),
                durationHours: document.getElementById('manual-duration-hours'),
                durationMinutes: document.getElementById('manual-duration-minutes'),
                addButton: document.getElementById('add-manual-session-btn'),
                currentMode: 'precise',
            };
            const toastEl = document.getElementById('toast');
            const modal = {
                container: document.getElementById('confirmation-modal'),
                confirmBtn: document.getElementById('modal-confirm-btn'),
                cancelBtn: document.getElementById('modal-cancel-btn'),
            };
            const clockEl = document.getElementById('live-clock');

            const getISODateKey = (date) => date.toISOString().split('T')[0];
            const formatDuration = (ms) => {
                if (ms < 0) ms = 0;
                const totalSeconds = Math.floor(ms / 1000), hours = Math.floor(totalSeconds / 3600),
                    minutes = Math.floor((totalSeconds % 3600) / 60);
                let str = '';
                if (hours > 0) str += `${hours}h `;
                if (minutes > 0) str += `${minutes}m `;
                if (hours === 0 && minutes === 0) str += `${totalSeconds % 60}s`;
                return str.trim() || '0s';
            };
            const formatTimer = (ms) => {
                if (ms < 0) ms = 0;
                const totalSeconds = Math.floor(ms / 1000), hours = Math.floor(totalSeconds / 3600),
                    minutes = Math.floor((totalSeconds % 3600) / 60), seconds = totalSeconds % 60;
                return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }
            const saveState = () => localStorage.setItem('disciplineArchitectSessions', JSON.stringify(state.sessions));
            const showToast = (message, isError = false) => {
                toastEl.textContent = message;
                toastEl.style.borderColor = isError ? '#da3633' : '#2ea043';
                toastEl.classList.add('show');
                setTimeout(() => { toastEl.classList.remove('show'); }, 3000);
            };
            const updateLiveClock = () => {
                if (!clockEl) return;
                const now = new Date();
                const options = { weekday: 'long', year: 'numeric', month: 'short', day: 'numeric' };
                const dateString = now.toLocaleDateString('en-US', options);
                const timeString = now.toLocaleTimeString();
                clockEl.textContent = `${dateString} | ${timeString}`;
            };

            const render = () => {
                Object.values(pages).forEach(p => p.classList.remove('active'));
                Object.values(nav).forEach(n => n.classList.remove('active'));
                pages[state.activePage].classList.add('active');
                nav[state.activePage].classList.add('active');
                renderDashboard();
                if (state.activePage === 'analysis') renderAnalysis('all');
            };
            const renderDashboard = () => {
                sessionControls.startCard.classList.toggle('hidden', !!state.currentSession);
                sessionControls.currentCard.classList.toggle('hidden', !state.currentSession);
                if (state.currentSession) {
                    sessionControls.currentTitle.textContent = state.currentSession.title;
                    sessionControls.currentCategory.textContent = state.currentSession.category;
                } else {
                    sessionControls.timer.textContent = "00:00:00";
                }
                renderTodaysLog();
            };
            const renderTodaysLog = () => {
                const todayKey = getISODateKey(new Date());
                const todaysSessions = state.sessions[todayKey] || [];
                logs.today.innerHTML = '';
                if (todaysSessions.length === 0) {
                    logs.today.innerHTML = `<p id="no-sessions-msg" class="text-gray-500 text-center mt-10">No sessions logged yet today.</p>`;
                } else {
                    todaysSessions.slice().reverse().forEach(session => {
                        const sessionEl = document.createElement('div');
                        sessionEl.className = 'session-log-item p-3 border border-[#30363d] rounded-lg bg-[#0d1117] flex justify-between items-center transition-shadow hover:shadow-md hover:border-green-500';
                        sessionEl.innerHTML = `
                            <div>
                                <p class="font-semibold text-gray-200">${session.title}</p>
                                <p class="text-sm text-gray-400">${session.category}</p>
                            </div>
                            <div class="flex items-center gap-4">
                                <div class="text-right">
                                    <p class="font-bold text-green-400 font-mono">${formatDuration(session.duration)}</p>
                                    <p class="text-xs text-gray-500">
                                        ${new Date(session.startTime).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })} - ${new Date(session.endTime).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                                    </p>
                                </div>
                                <button data-session-id="${session.startTime}" class="delete-session-btn text-red-500 hover:text-red-400 p-1 rounded-full hover:bg-red-900/50">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                                </button>
                            </div>
                        `;
                        logs.today.appendChild(sessionEl);
                    });
                }
            };

            const getSessionsForPeriod = (period) => {
                const today = new Date();
                const todayKey = getISODateKey(today);
                if (period === 'today') return state.sessions[todayKey] ? { [todayKey]: state.sessions[todayKey] } : {};
                if (period === 'week') {
                    const weekData = {};
                    for (let i = 0; i < 7; i++) {
                        const date = new Date();
                        date.setDate(today.getDate() - i);
                        const dateKey = getISODateKey(date);
                        if (state.sessions[dateKey]) weekData[dateKey] = state.sessions[dateKey];
                    }
                    return weekData;
                }
                if (period === 'month') {
                    const monthData = {};
                    const currentMonth = today.getMonth();
                    const currentYear = today.getFullYear();
                    for (const dateKey in state.sessions) {
                        const sessionDate = new Date(dateKey);
                        if (sessionDate.getMonth() === currentMonth && sessionDate.getFullYear() === currentYear) {
                            monthData[dateKey] = state.sessions[dateKey];
                        }
                    }
                    return monthData;
                }
                if (period === 'all') return state.sessions;
                return state.sessions[period] ? { [period]: state.sessions[period] } : {};
            };
            const renderAnalysis = (period) => {
                const sessionsData = getSessionsForPeriod(period);
                const sessionsToAnalyze = Object.values(sessionsData).flat();
                let titleDate = `(${period.charAt(0).toUpperCase() + period.slice(1)})`;
                if (period === 'all') titleDate = "(All Time)";
                else if (!['today', 'week', 'month'].includes(period)) {
                    titleDate = `for ${new Date(period + 'T00:00:00').toLocaleDateString()}`;
                }
                analysisElements.statsTitle.textContent = `Key Statistics ${titleDate}`;
                analysisElements.pieChartTitle.textContent = `Category Breakdown ${titleDate}`;
                analysisElements.barChartTitle.textContent = `Activity by Category`;
                analysisElements.sessionDetailsTitle.textContent = `Session Details ${titleDate}`;
                
                const { mostFrequent, mostProductiveDay, totalDuration, productiveDuration, sessionCount } = getStatsForPeriod(sessionsData);
                analysisElements.statsTotalTime.textContent = formatDuration(totalDuration) || '0m';
                analysisElements.statsMostFrequent.textContent = mostFrequent || 'N/A';
                analysisElements.statsMostProductiveDay.textContent = (period === 'today' || period.includes('-')) ? 'N/A' : mostProductiveDay || 'N/A';
                analysisElements.statsAvgSession.textContent = sessionCount > 0 ? formatDuration(totalDuration / sessionCount) : '0m';
                analysisElements.statsProductivityScore.textContent = totalDuration > 0 ? `${Math.round((productiveDuration / totalDuration) * 100)}%` : '0%';

                renderCategoryPieChart(sessionsToAnalyze);
                renderActivityBarChart(sessionsToAnalyze);
                renderProductivityLineChart();
                renderProductivitySplitChart(totalDuration, productiveDuration);
                renderSessionDetails(sessionsToAnalyze);
            };
            const getStatsForPeriod = (sessionsData) => {
                const categoryCounts = {}, dailyProductiveDurations = {};
                const productiveCategories = ['Study', 'Work', 'Fitness', 'Reading', 'Chores', 'Other'];
                let totalDuration = 0;
                let productiveDuration = 0;
                let sessionCount = 0;

                Object.entries(sessionsData).forEach(([date, sessions]) => {
                    dailyProductiveDurations[date] = 0;
                    sessions.forEach(s => {
                        sessionCount++;
                        totalDuration += s.duration;
                        categoryCounts[s.category] = (categoryCounts[s.category] || 0) + 1;
                        if (productiveCategories.includes(s.category)) {
                            const duration = s.duration;
                            dailyProductiveDurations[date] += duration;
                            productiveDuration += duration;
                        }
                    });
                });

                let mostProductiveDay = null, maxProductiveDuration = 0;
                Object.entries(dailyProductiveDurations).forEach(([date, duration]) => {
                    if (duration > maxProductiveDuration) {
                        maxProductiveDuration = duration;
                        mostProductiveDay = new Date(date + 'T00:00:00').toLocaleDateString([], { weekday: 'long' });
                    }
                });

                let mostFrequent = 'N/A', maxCount = 0;
                Object.entries(categoryCounts).forEach(([cat, count]) => {
                    if (count > maxCount) { maxCount = count; mostFrequent = cat; }
                });

                return { mostFrequent, mostProductiveDay, totalDuration, productiveDuration, sessionCount };
            };

            const chartColors = { Study: '#2ea043', Work: '#3fb950', Fitness: '#56d364', Reading: '#00a39f', Entertainment: '#f0b623', YouTube: '#dbab09', Instagram: '#e1306c', Chores: '#a371f7', Social: '#d2a8ff', Other: '#8b949e' };
            const renderChart = (chartInstance, canvas, type, data, options) => {
                if (chartInstance) chartInstance.destroy();
                canvas.getContext('2d').clearRect(0,0,canvas.width, canvas.height);
                if (data.datasets[0].data.length === 0 || data.datasets[0].data.every(item => item === 0)) return null;
                return new Chart(canvas, { type, data, options });
            };
            const renderCategoryPieChart = (sessions) => {
                const totals = sessions.reduce((acc, s) => { acc[s.category] = (acc[s.category] || 0) + s.duration; return acc; }, {});
                const data = { labels: Object.keys(totals), datasets: [{ data: Object.values(totals), backgroundColor: Object.keys(totals).map(l => chartColors[l] || '#8b949e'), borderWidth: 0 }] };
                const options = {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: '#c9d1d9'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.raw !== null) {
                                        label += formatDuration(context.raw);
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                };
                state.categoryChart = renderChart(state.categoryChart, analysisElements.categoryCanvas, 'doughnut', data, options);
            };
            const renderActivityBarChart = (sessions) => {
                const totals = sessions.reduce((acc, s) => { acc[s.category] = (acc[s.category] || 0) + s.duration; return acc; }, {});
                const data = { labels: Object.keys(totals), datasets: [{ label: 'Hours', data: Object.values(totals).map(ms => ms / 3600000), backgroundColor: Object.keys(totals).map(l => chartColors[l] || '#8b949e') }] };
                const options = { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    indexAxis: 'y', 
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (context) => `${context.dataset.label}: ${context.raw.toFixed(2)} hours`
                            }
                        }
                    }, 
                    scales: { 
                        x: { ticks: { color: '#c9d1d9' } }, 
                        y: { ticks: { color: '#c9d1d9' } } } 
                    };
                state.activityChart = renderChart(state.activityChart, analysisElements.activityCanvas, 'bar', data, options);
            };

            const renderProductivityLineChart = () => {
                const productiveCategories = ['Study', 'Work', 'Fitness', 'Reading', 'Chores', 'Other'];
                const trendData = { labels: [], data: [] };

                for (let i = 6; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    const dateKey = getISODateKey(date);
                    trendData.labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                    
                    const daySessions = state.sessions[dateKey] || [];
                    const productiveTime = daySessions
                        .filter(s => productiveCategories.includes(s.category))
                        .reduce((acc, s) => acc + s.duration, 0);
                    
                    trendData.data.push(productiveTime / 3600000); // Convert to hours
                }

                const data = {
                    labels: trendData.labels,
                    datasets: [{
                        label: 'Productive Hours',
                        data: trendData.data,
                        borderColor: '#2ea043',
                        backgroundColor: 'rgba(46, 160, 67, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                };

                const options = {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (context) => `${context.dataset.label}: ${context.raw.toFixed(2)} hours`
                            }
                        }
                    },
                    scales: {
                        y: { beginAtZero: true, ticks: { callback: (value) => `${value}h` } }
                    }
                };

                state.lineChart = renderChart(state.lineChart, analysisElements.lineCanvas, 'line', data, options);
            };

            const renderProductivitySplitChart = (totalDuration, productiveDuration) => {
                const distractionDuration = totalDuration - productiveDuration;
                const data = {
                    labels: ['Productive', 'Distraction'],
                    datasets: [{
                        data: [productiveDuration, distractionDuration],
                        backgroundColor: ['#2ea043', '#dbab09'],
                        borderWidth: 0
                    }]
                };
                const options = {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', labels: { color: '#c9d1d9' } },
                        tooltip: {
                            callbacks: {
                                label: (context) => `${context.label}: ${formatDuration(context.raw)}`
                            }
                        }
                    }
                };
                state.splitChart = renderChart(state.splitChart, analysisElements.splitCanvas, 'doughnut', data, options);
            };
            
            const renderSessionDetails = (sessions) => {
                analysisElements.sessionDetailsList.innerHTML = '';
                if (sessions.length === 0) {
                    analysisElements.sessionDetailsList.innerHTML = `<p class="text-gray-500 text-center">No sessions in this period.</p>`;
                    return;
                }
                const sortedSessions = sessions.sort((a,b) => new Date(b.startTime) - new Date(a.startTime));
                sortedSessions.forEach(session => {
                    const el = document.createElement('div');
                    el.className = 'grid grid-cols-3 gap-4 items-center p-2 border-b border-gray-700 text-sm';
                    el.innerHTML = `
                        <div class="col-span-2">
                            <p class="font-semibold text-gray-200 truncate">${session.title}</p>
                            <p class="text-xs text-gray-400">${session.category}</p>
                        </div>
                        <div class="text-right font-mono text-green-400">${formatDuration(session.duration)}</div>
                    `;
                    analysisElements.sessionDetailsList.appendChild(el);
                });
            };

            const handleStartSession = () => {
                const title = sessionControls.titleInput.value.trim();
                if (!title) { showToast('Please enter a title.', true); return; }
                if (state.currentSession) return;
                state.currentSession = { title, category: sessionControls.categorySelect.value, startTime: new Date().toISOString(), intervalId: setInterval(updateTimer, 1000) };
                sessionControls.titleInput.value = '';
                renderDashboard();
            };
            const updateTimer = () => {
                if (!state.currentSession) return;
                sessionControls.timer.textContent = formatTimer(new Date() - new Date(state.currentSession.startTime));
            };
            const handleEndSession = () => {
                if (!state.currentSession) return;
                clearInterval(state.currentSession.intervalId);
                const todayKey = getISODateKey(new Date());
                if (!state.sessions[todayKey]) state.sessions[todayKey] = [];
                const endTime = new Date(), startTime = new Date(state.currentSession.startTime);
                state.sessions[todayKey].push({ ...state.currentSession, endTime: endTime.toISOString(), duration: endTime - startTime, intervalId: null });
                state.currentSession = null;
                saveState();
                renderDashboard();
            };
            
            const handleAddManualSession = () => {
                const title = manualControls.title.value.trim();
                const category = manualControls.category.value;
                if (!title) {
                    showToast('Title is required.', true);
                    return;
                }
                let startTime, endTime, duration;
                const todayDateKey = getISODateKey(new Date());
                const datePart = `${todayDateKey}T`;

                if (manualControls.currentMode === 'precise') {
                    const startTimeValue = manualControls.startTime.value;
                    const endTimeValue = manualControls.endTime.value;
                    if (!startTimeValue || !endTimeValue) {
                        showToast('Start and end times are required for precise mode.', true);
                        return;
                    }
                    startTime = new Date(datePart + startTimeValue);
                    endTime = new Date(datePart + endTimeValue);
                    if (endTime <= startTime) {
                        showToast('End time must be after start time.', true);
                        return;
                    }
                    duration = endTime - startTime;
                } else { 
                    const hours = parseInt(manualControls.durationHours.value, 10) || 0;
                    const minutes = parseInt(manualControls.durationMinutes.value, 10) || 0;
                    if (hours === 0 && minutes === 0) {
                        showToast('Duration must be greater than zero.', true);
                        return;
                    }
                    duration = (hours * 3600 + minutes * 60) * 1000;
                    endTime = new Date();
                    startTime = new Date(endTime.getTime() - duration);
                }
                
                const newSession = { title, category, startTime: startTime.toISOString(), endTime: endTime.toISOString(), duration, };
                const dateKey = getISODateKey(startTime);
                if (!state.sessions[dateKey]) { state.sessions[dateKey] = []; }
                state.sessions[dateKey].push(newSession);
                state.sessions[dateKey].sort((a, b) => new Date(a.startTime) - new Date(b.startTime));
                saveState();
                renderDashboard();
                showToast('Manual session added successfully!');
                manualControls.title.value = '';
                manualControls.startTime.value = '';
                manualControls.endTime.value = '';
                manualControls.durationHours.value = '';
                manualControls.durationMinutes.value = '';
            };

            const handleNav = (page) => { state.activePage = page; render(); };
            const exportData = (data, filename) => {
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = filename; a.click();
                URL.revokeObjectURL(url);
            };
            const handleExportToday = () => {
                const todayKey = getISODateKey(new Date());
                const todayData = state.sessions[todayKey];

                if (!todayData || todayData.length === 0) {
                    showToast("No data for today to save.", true);
                    return;
                }

                const dataToExport = { [todayKey]: todayData };
                const filename = `${todayKey}.json`;
                exportData(dataToExport, filename);
                showToast("Today's data saved successfully!");
            };
            const handleExportAll = () => {
                if (Object.keys(state.sessions).length === 0) { showToast("No data to export.", true); return; }
                exportData(state.sessions, 'discipline_data_all.json');
                showToast("All data exported successfully!");
            };
            const handleImport = async () => {
                let importedCount = 0;
                for (const file of dataControls.importInput.files) {
                    try {
                        const importedData = JSON.parse(await file.text());
                        if (typeof importedData !== 'object' || importedData === null) continue;
                        for(const dateKey in importedData) {
                            if(Array.isArray(importedData[dateKey])) {
                                state.sessions[dateKey] = state.sessions[dateKey] || [];
                                const existingStartTimes = new Set(state.sessions[dateKey].map(s => s.startTime));
                                const newSessions = importedData[dateKey].filter(s => !existingStartTimes.has(s.startTime));
                                state.sessions[dateKey].push(...newSessions);
                            }
                        }
                        importedCount++;
                    } catch (error) { showToast(`Error processing ${file.name}.`, true); }
                }
                if (importedCount > 0) {
                    saveState(); render();
                    showToast(`${importedCount} file(s) imported successfully!`);
                }
                dataControls.importInput.value = '';
            };

            const handleLoadFromGithub = async (isSilent = false) => {
                try {
                    if (!isSilent) {
                        showToast('Loading data from cloud...');
                    }
                    const manifestResponse = await fetch('./data_manifest.json');
                    
                    if (!manifestResponse.ok) {
                        if (isSilent) {
                            console.log('No cloud manifest found, skipping auto-load.');
                            return;
                        }
                        throw new Error('Manifest file not found.');
                    }

                    const filePaths = await manifestResponse.json();
                    if (!Array.isArray(filePaths)) throw new Error('Manifest is not a valid list.');

                    const allData = await Promise.all(
                        filePaths.map(path => fetch(path).then(res => res.json()))
                    );

                    const newSessions = {};
                    allData.forEach(dayData => {
                        Object.assign(newSessions, dayData);
                    });

                    state.sessions = newSessions;
                    saveState();
                    render();
                    if (!isSilent) {
                        showToast('Cloud data loaded successfully!');
                    } else {
                        console.log('Cloud data synced automatically.');
                    }

                } catch(error) {
                    if (!isSilent) {
                        showToast(`Error loading from cloud: ${error.message}`, true);
                    } else {
                        console.error('Silent cloud sync failed:', error.message);
                    }
                }
            };

            const handleClearData = () => {
                state.sessionToDelete = 'all_data';
                modal.container.classList.add('show');
            };
            const handleDeleteRequest = (e) => {
                const target = e.target.closest('.delete-session-btn');
                if (target) {
                    state.sessionToDelete = target.dataset.sessionId;
                    modal.container.classList.add('show');
                }
            };
            const confirmDeletion = () => {
                if (state.sessionToDelete === 'all_data') {
                    state.sessions = {};
                    localStorage.clear();
                    showToast("All browser data cleared.", true);
                } else if (state.sessionToDelete) {
                    const todayKey = getISODateKey(new Date());
                    if (state.sessions[todayKey] && Array.isArray(state.sessions[todayKey])) {
                        const updatedSessions = state.sessions[todayKey].filter(s => s.startTime !== state.sessionToDelete);
                        if (updatedSessions.length > 0) {
                            state.sessions[todayKey] = updatedSessions;
                        } else {
                            delete state.sessions[todayKey];
                        }
                        saveState();
                        showToast("Session removed.");
                    }
                }
                render();
                closeModal();
            };
            const closeModal = () => {
                state.sessionToDelete = null;
                modal.container.classList.remove('show');
            };
            const checkForDailyExport = () => {
                const todayKey = getISODateKey(new Date()), lastExportDate = localStorage.getItem('lastAutoExportDate');
                if (todayKey === lastExportDate) return;
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayKey = getISODateKey(yesterday), yesterdayData = state.sessions[yesterdayKey];
                if (yesterdayData && yesterdayData.length > 0) {
                    showToast(`New day! Exporting data for ${yesterdayKey}...`);
                    setTimeout(() => exportData({ [yesterdayKey]: yesterdayData }, `${yesterdayKey}.json`), 500);
                }
                localStorage.setItem('lastAutoExportDate', todayKey);
            };
            const setupManualModeToggle = () => {
                const setMode = (mode) => {
                    manualControls.currentMode = mode;
                    if (mode === 'precise') {
                        manualControls.modePreciseBtn.classList.add('active');
                        manualControls.modeDurationBtn.classList.remove('active');
                        manualControls.preciseInputs.classList.remove('hidden');
                        manualControls.durationInputs.classList.add('hidden');
                    } else {
                        manualControls.modePreciseBtn.classList.remove('active');
                        manualControls.modeDurationBtn.classList.add('active');
                        manualControls.preciseInputs.classList.add('hidden');
                        manualControls.durationInputs.classList.remove('hidden');
                    }
                };
                manualControls.modePreciseBtn.addEventListener('click', () => setMode('precise'));
                manualControls.modeDurationBtn.addEventListener('click', () => setMode('duration'));
                setMode('precise');
            };

            sessionControls.startButton.addEventListener('click', handleStartSession);
            sessionControls.endButton.addEventListener('click', handleEndSession);
            Object.keys(nav).forEach(page => nav[page].addEventListener('click', () => handleNav(page)));
            dataControls.exportTodayButton.addEventListener('click', handleExportToday);
            dataControls.exportButton.addEventListener('click', handleExportAll);
            dataControls.importButton.addEventListener('click', () => dataControls.importInput.click());
            dataControls.importInput.addEventListener('change', handleImport);
            dataControls.clearButton.addEventListener('click', handleClearData);
            dataControls.loadGithubBtn.addEventListener('click', () => handleLoadFromGithub(false));
            logs.today.addEventListener('click', handleDeleteRequest);
            modal.confirmBtn.addEventListener('click', confirmDeletion);
            modal.cancelBtn.addEventListener('click', closeModal);
            manualControls.addButton.addEventListener('click', handleAddManualSession);
            analysisElements.dateFilter.addEventListener('change', (e) => {
                analysisElements.filterBtns.forEach(b => b.classList.remove('active'));
                renderAnalysis(e.target.value)
            });
            analysisElements.resetFilterBtn.addEventListener('click', () => {
                analysisElements.dateFilter.value = '';
                analysisElements.filterBtns.forEach(b => b.classList.remove('active'));
                renderAnalysis('all');
            });
            analysisElements.filterBtns.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    analysisElements.filterBtns.forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    analysisElements.dateFilter.value = '';
                    renderAnalysis(e.target.dataset.period);
                });
            });
            
            render();
            checkForDailyExport();
            setupManualModeToggle();
            updateLiveClock();
            setInterval(updateLiveClock, 1000);

            if (window.location.protocol.startsWith('http')) {
                handleLoadFromGithub(true);
            }
        }
    });
    </script>
</body>
</html>

